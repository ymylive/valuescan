"""
TradingView å›¾è¡¨ç”Ÿæˆæ¨¡å—
ä½¿ç”¨ chart-img.com API ç”Ÿæˆ TradingView å›¾è¡¨å›¾ç‰‡
æ”¯æŒåŒæ­¥å’Œå¼‚æ­¥ç”Ÿæˆæ¨¡å¼
"""

import requests
import os
import threading
import time
from io import BytesIO
from concurrent.futures import ThreadPoolExecutor, as_completed
from logger import logger

# é»˜è®¤é…ç½®ï¼ˆå°†åœ¨ config.py ä¸­è®¾ç½®ï¼‰
DEFAULT_API_KEY = "123456789abcdef0123456789abcdef"
DEFAULT_LAYOUT_ID = "oeTZqtUR"
DEFAULT_CHART_WIDTH = 800
DEFAULT_CHART_HEIGHT = 600
DEFAULT_TIMEOUT = 90

# å¼‚æ­¥å›¾è¡¨ç”Ÿæˆé…ç½®
_executor = None
_chart_tasks = {}  # {task_id: {'status': 'processing', 'result': None, 'callback': func}}
_task_counter = 0
_lock = threading.Lock()


class AsyncChartManager:
    """å¼‚æ­¥å›¾è¡¨ç”Ÿæˆç®¡ç†å™¨"""
    
    @staticmethod
    def initialize(max_workers=3):
        """åˆå§‹åŒ–çº¿ç¨‹æ± """
        global _executor
        if _executor is None:
            _executor = ThreadPoolExecutor(max_workers=max_workers, thread_name_prefix="ChartGen")
            logger.info(f"ğŸ“Š å¼‚æ­¥å›¾è¡¨ç”Ÿæˆå™¨å·²åˆå§‹åŒ– (å·¥ä½œçº¿ç¨‹: {max_workers})")
    
    @staticmethod
    def shutdown():
        """å…³é—­çº¿ç¨‹æ± """
        global _executor
        if _executor:
            _executor.shutdown(wait=True)
            _executor = None
            logger.info("ğŸ“Š å¼‚æ­¥å›¾è¡¨ç”Ÿæˆå™¨å·²å…³é—­")
    
    @staticmethod
    def get_task_status(task_id):
